@model NhaSach.Web.Models.Sanpham
@{
    ViewData["Title"] = "Thêm sản phẩm";
}
<h2>Thêm sản phẩm</h2>

<form asp-action="Tao" method="post" enctype="multipart/form-data" class="mt-3">
    @Html.AntiForgeryToken()
    <div asp-validation-summary="ModelOnly" class="text-danger"></div>

    <div class="row g-3">
        <div class="col-md-6">
            <label class="form-label">Tên sản phẩm</label>
            <input asp-for="Ten_Sanpham" class="form-control" />
            <span asp-validation-for="Ten_Sanpham" class="text-danger"></span>
        </div>

        <div class="col-md-3">
            <label class="form-label">Giá bán</label>
            <input asp-for="Gia_Ban" class="form-control" inputmode="numeric" />
            <span asp-validation-for="Gia_Ban" class="text-danger"></span>
        </div>

        <!-- NEW: Giá khuyến mãi -->
        <div class="col-md-3">
            <label class="form-label">Giá khuyến mãi</label>
            <div class="input-group">
                <input asp-for="GiaKhuyenMai" class="form-control" inputmode="numeric" />
                <span class="input-group-text bg-light text-muted" id="saleOffBadge">-0%</span>
            </div>
            <span asp-validation-for="GiaKhuyenMai" class="text-danger"></span>
            <small class="text-muted">Để trống (hoặc ≥ Giá bán) nếu không chạy khuyến mãi.</small>
        </div>

        <div class="col-md-3">
            <label class="form-label">Tồn kho</label>
            <input asp-for="SoLuong_Ton" class="form-control" inputmode="numeric" />
        </div>

        <div class="col-md-4">
            <label class="form-label">Danh mục</label>
            <select asp-for="Danhmuc_Id" asp-items="ViewBag.Danhmucs" class="form-select"></select>
        </div>
        <div class="col-md-4">
            <label class="form-label">SKU</label>
            <input asp-for="SKU_Sanpham" class="form-control" />
        </div>
        <div class="col-md-4">
            <label class="form-label">Tác giả</label>
            <input asp-for="TacGia" class="form-control" />
        </div>

        <div class="col-md-6">
            <label class="form-label">Nhà Xuất bản</label>
            <input asp-for="NhaXuatBan" class="form-control" />
        </div>
        <div class="col-md-3">
            <label class="form-label">Năm Xuất bản</label>
            <input asp-for="NamXuatBan" class="form-control" />
        </div>
        <div class="col-md-3">
            <label class="form-label">ISBN</label>
            <input asp-for="ISBN" class="form-control" />
        </div>

        <div class="col-12">
            <label class="form-label">Mô tả ngắn</label>
            <textarea asp-for="MoTaNgan_Sanpham" class="form-control" rows="2"></textarea>
        </div>
        <div class="col-12">
            <label class="form-label">Mô tả chi tiết</label>
            <textarea asp-for="MoTa_Sanpham" class="form-control" rows="5"></textarea>
        </div>

        <div class="col-md-6">
            <label class="form-label">Ảnh chính</label>
            <input type="file" id="anh" name="anh" class="form-control" accept="image/*" />
            <small class="text-muted">JPEG/PNG/GIF/WEBP, ≤ 2MB</small>
            <div class="mt-2">
                <img id="preview" style="max-height:120px;display:none;border:1px solid #eee;border-radius:.25rem;" />
            </div>
        </div>
    </div>

    <div class="mt-3">
        <button class="btn btn-primary" type="submit">Lưu</button>
        <a class="btn btn-secondary" asp-action="Index">Huỷ</a>
    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Preview ảnh
        document.getElementById('anh')?.addEventListener('change', e => {
            const f = e.target.files?.[0]; if (!f) return;
            const okType = /^image\/(jpeg|png|gif|webp)$/i.test(f.type);
            const okSize = f.size <= 2 * 1024 * 1024;
            if (!okType || !okSize) {
                alert('Chỉ cho phép JPEG/PNG/GIF/WEBP và ≤ 2MB.');
                e.target.value = '';
                document.getElementById('preview').style.display = 'none';
                return;
            }
            const img = document.getElementById('preview');
            img.src = URL.createObjectURL(f);
            img.style.display = 'inline-block';
        });

        // Tính % giảm cho Giá khuyến mãi
        const elGia = document.getElementById('Gia_Ban');
        const elKm = document.getElementById('GiaKhuyenMai');
        const saleOff = document.getElementById('saleOffBadge');

        function updateSale() {
            const g = parseFloat((elGia?.value || '0').replace(/,/g, '.'));
            const k = parseFloat((elKm?.value || '').replace(/,/g, '.'));

            if (!isNaN(g) && !isNaN(k) && k > 0 && k < g) {
                const p = Math.max(0, Math.min(99, Math.round(100 - k * 100 / g)));
                saleOff.textContent = `-${p}%`;
                elKm.setCustomValidity('');
            } else {
                saleOff.textContent = '-0%';
                if (!isNaN(g) && !isNaN(k) && k >= g && elKm.value !== '') {
                    elKm.setCustomValidity('Giá khuyến mãi phải nhỏ hơn Giá bán.');
                } else {
                    elKm.setCustomValidity('');
                }
            }
        }
        elGia?.addEventListener('input', updateSale);
        elKm?.addEventListener('input', updateSale);
        updateSale();
    </script>
}
